import 'dotenv/config'
import {
  getSecurityTrailsSubdomainList,
  getBinaryEdgeSubdomainList,
  getGithubSubdomainList,
  getRdap
} from './apis'
import { writeFile } from './util'

async function main(): Promise<void> {
  const domain = process.argv[2]

  const subdomainList = (
    await Promise.all([
      getSecurityTrailsSubdomainList(domain),
      getBinaryEdgeSubdomainList(domain),
      getGithubSubdomainList(domain)
    ])
  )
    .flat()
    .filter((subdomain, i, ar) => ar.indexOf(subdomain) === i)

  const result: Record<string, Record<string, unknown>> = {}
  for (const subdomain of subdomainList) {
    const data = await getRdap(subdomain)
    if (data) {
      process.stdout.write(JSON.stringify({ subdomain, data }, null, 2) + '\n')
      result[subdomain] = data
    }
  }

  writeFile('subdomains.json', JSON.stringify(result, null, 2))
}

main()
