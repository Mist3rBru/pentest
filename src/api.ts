import axios from 'axios'
import dns from 'node:dns'
import util from 'node:util'

const getIp = util.promisify(dns.resolve4)

export async function getRdap(subdomain: string) {
  try {
    const ipList = await getIp(subdomain)
    for (const ip of ipList) {
      const { data } = await axios.get<{ handle: string } | ''>(
        `https://rdap.registro.br/ip/${ip}`,
        { validateStatus: () => true }
      )
      if (!data) continue

      return { ip, CIDR: data.handle }
    }
  } catch (err) {}
}

export async function getGithubSubdomainList(
  domain: string
): Promise<string[]> {
  const { data: subdomainListResponse } = await axios.get<string>(
    'https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/DNS/subdomains-top1million-5000.txt',
    { validateStatus: () => true }
  )
  return subdomainListResponse
    .split('\n')
    .map((subdomain) => `${subdomain}.${domain}`)
}

export async function getBinaryEdgeSubdomainList(
  domain: string
): Promise<string[]> {
  const { data } = await axios.get<BinaryEdgeResponse>(
    `https://api.binaryedge.io/v2/query/domains/subdomain/${domain}`,
    {
      headers: {
        'X-Key': process.env.BINARY_EDGE_TOKEN
      }
    }
  )
  return data.events
}

export async function getSecurityTrailsSubdomainList(
  domain: string
): Promise<string[]> {
  const { data } = await axios.get<SecurityTrailsResponse>(
    `https://api.securitytrails.com/v1/domain/${domain}/subdomains?children_only=false&include_inactive=true`,
    {
      headers: {
        APIKEY: process.env.SECURITY_TRAILS_TOKEN
      }
    }
  )
  return data.subdomains.map((subdomain) => `${subdomain}.${domain}`)
}
